var music={
  audioCtx:null,
  gainNode:null,
  panNode:null,
  f:[],
  notelen:(1/7) // ~143ms
};

function music_init()
{
  try
  {
    const AudioContext=window.AudioContext || window.webkitAudioContext;
    music.audioCtx=new AudioContext();

    // Add volume control
    music.gainNode=music.audioCtx.createGain();
    music.gainNode.connect(music.audioCtx.destination);
    music.gainNode.gain.setValueAtTime(0.012, music.audioCtx.currentTime);

    // Add audio panning
    music.panNode=music.audioCtx.createStereoPanner();
    music.panNode.connect(music.gainNode);

    // Load up song
    music.f=[
      // "The Chrysanthemum" by Scott Joplin
      [161,4],[169,5],[177,6],[137,7],[149,8],[157,9],[161,10],[129,11],[141,12],[149,13],[157,14],[121,15],[121,16],[141,17],[121,18],[121,20],[125,21],[129,22],[161,23],[129,24],[133,25],[137,26],[161,27],[157,28],[141,29],[157,30],[169,31],[169,32],[157,34],[161,36],[169,37],[177,38],[137,39],[149,40],[157,41],[161,42],[129,43],[141,44],[149,45],[157,46],[121,47],[121,48],[117,49],[121,50],[129,51],[137,52],[141,53],[145,54],[149,55],[157,56],[149,57],[141,58],[177,59],[169,60],[169,64],[157,66],[161,68],[169,69],[177,70],[137,71],[149,72],[157,73],[161,74],[129,75],[141,76],[149,77],[157,78],[121,79],[121,80],[141,81],[121,82],[121,84],[125,85],[129,86],[161,87],[129,88],[133,89],[137,90],[161,91],[157,92],[141,93],[157,94],[169,95],[169,96],[157,100],[161,101],[169,102],[129,103],[145,104],[149,105],[157,106],[129,107],[149,108],[145,109],[149,110],[157,111],[161,112],[165,114],[169,116],[189,117],[169,118],[157,119],[141,120],[121,121],[137,122],[169,123],[141,124],[141,128],[157,130],

      [53,4],[89,6],[25,8],[89,10],[45,12],[93,14],[25,16],[93,18],[41,20],[89,22],[25,24],[101,26],[45,28],[93,30],[61,32],[93,34],[53,36],[89,38],[25,40],[89,42],[45,44],[93,46],[49,48],[85,50],[53,52],[89,54],[49,56],[101,58],[101,60],[49,61],[53,62],[25,64],[53,68],[89,70],[25,72],[89,74],[45,76],[93,78],[25,80],[93,82],[41,84],[89,86],[25,88],[101,90],[45,92],[93,94],[61,96],[93,98],[81,100],[97,102],[73,104],[93,106],[65,108],[81,110],[33,112],[33,114],[73,116],[93,118],[73,120],[89,122],[45,124],[73,126],[61,128],

      // "Black & White Rag" by George Botsford
      [157,134],[153,136],[149,138],[157,139],[173,140],[149,141],[157,142],[173,143],[149,144],[157,145],[173,146],[149,147],[157,148],[173,149],[165,151],[157,152],[149,153],[141,154],[145,155],[165,156],[141,157],[145,158],[165,159],[141,160],[145,161],[165,162],[141,163],[145,164],[165,165],[157,167],[145,168],[129,169],[149,170],[145,172],[149,173],[145,175],[149,176],[137,178],[133,180],[137,181],[133,183],[137,184],[129,186],[105,187],[109,188],[129,189],[145,190],[125,191],[129,192],[145,193],[157,194],[141,195],[145,196],[157,197],[177,198],[145,200],[149,202],[157,203],[173,204],[149,205],[157,206],[173,207],[149,208],[157,209],[173,210],[149,211],[157,212],[173,213],[165,215],[157,216],[149,217],[141,218],[145,219],[165,220],[141,221],[145,222],[165,223],[141,224],[145,225],[165,226],[141,227],[145,228],[165,229],[157,231],[149,232],[145,233],[165,234],[117,235],[133,236],[165,237],[157,239],[149,240],[145,241],[137,242],[133,243],[137,244],[165,245],[157,247],[149,248],[137,249],[145,250],[109,251],[129,252],[145,253],[109,255],[137,256],[129,258],[177,262],[193,266],[205,267],[225,268],[177,269],[193,270],[205,271],[157,272],[177,273],[193,274],[145,275],[157,276],[177,277],[129,278],[145,279],[157,280],[109,281],[124,282],[121,284],[124,285],[121,287],[124,288],[124,290],[129,291],[133,292],[137,293],[133,295],[137,296],[197,298],[205,299],[221,300],[185,301],[197,302],[205,303],[173,304],[185,305],[197,306],[157,307],[173,308],[185,309],[149,310],[149,311],[173,312],[137,313],[145,314],[141,316],[145,317],[141,319],[145,320],[145,322],[149,323],[153,324],[157,325],[153,327],[157,328],[181,330],[193,331],[205,332],[165,333],[181,334],[193,335],[157,336],[165,337],[181,338],[145,339],[157,340],[165,341],[133,342],[185,346],[197,347],[213,348],[165,349],[185,350],[197,351],[149,352],[165,353],[185,354],[137,355],[149,356],[165,357],[117,358],[193,362],[205,363],[225,364],[177,365],[193,366],[205,367],[157,368],[177,369],[193,370],[145,371],[157,372],[177,373],[129,374],[145,375],[157,376],[129,377],[109,378],[124,379],[137,380],[157,381],[149,383],[137,384],[129,386],

      [157,134],[153,136],[149,138],[157,139],[173,140],[149,141],[157,142],[173,143],[149,144],[157,145],[173,146],[149,147],[157,148],[173,149],[165,151],[157,152],[149,153],[141,154],[145,155],[165,156],[141,157],[145,158],[165,159],[141,160],[145,161],[165,162],[141,163],[145,164],[165,165],[157,167],[145,168],[129,169],[149,170],[145,172],[149,173],[145,175],[149,176],[137,178],[133,180],[137,181],[133,183],[137,184],[129,186],[105,187],[109,188],[129,189],[145,190],[125,191],[129,192],[145,193],[157,194],[141,195],[145,196],[157,197],[177,198],[145,200],[149,202],[157,203],[173,204],[149,205],[157,206],[173,207],[149,208],[157,209],[173,210],[149,211],[157,212],[173,213],[165,215],[157,216],[149,217],[141,218],[145,219],[165,220],[141,221],[145,222],[165,223],[141,224],[145,225],[165,226],[141,227],[145,228],[165,229],[157,231],[149,232],[145,233],[165,234],[117,235],[133,236],[165,237],[157,239],[149,240],[145,241],[137,242],[133,243],[137,244],[165,245],[157,247],[149,248],[137,249],[145,250],[109,251],[129,252],[145,253],[109,255],[137,256],[129,258],[177,262],[193,266],[205,267],[225,268],[177,269],[193,270],[205,271],[157,272],[177,273],[193,274],[145,275],[157,276],[177,277],[129,278],[145,279],[157,280],[109,281],[124,282],[121,284],[124,285],[121,287],[124,288],[124,290],[129,291],[133,292],[137,293],[133,295],[137,296],[197,298],[205,299],[221,300],[185,301],[197,302],[205,303],[173,304],[185,305],[197,306],[157,307],[173,308],[185,309],[149,310],[157,311],[173,312],[137,313],[145,314],[141,316],[145,317],[141,319],[145,320],[145,322],[149,323],[153,324],[157,325],[153,327],[157,328],[181,330],[193,331],[205,332],[165,333],[181,334],[193,335],[157,336],[165,337],[181,338],[145,339],[157,340],[165,341],[133,342],[185,346],[197,347],[213,348],[165,349],[185,350],[197,351],[149,352],[165,353],[185,354],[137,355],[149,356],[165,357],[117,358],[193,362],[205,363],[225,364],[177,365],[193,366],[205,367],[157,368],[177,369],[193,370],[145,371],[157,372],[177,373],[129,374],[145,375],[157,376],[129,377],[109,378],[124,379],[137,380],[157,381],[149,383],[137,384],[129,386],

      [97,134],[93,136],[89,138],[109,140],[61,142],[109,144],[89,146],[109,148],[61,150],[109,152],[81,154],[109,156],[61,158],[109,160],[81,162],[109,164],[61,166],[109,168],[89,170],[109,172],[61,174],[109,176],[77,178],[109,180],[61,182],[109,184],[81,186],[85,200],[89,202],[109,204],[61,206],[109,208],[89,210],[109,212],[61,214],[109,216],[81,218],[109,220],[61,222],[109,224],[81,226],[109,228],[61,230],[109,232],[85,234],[109,236],[69,238],[109,240],[89,242],[117,244],[69,246],[101,248],[61,250],[97,252],[61,254],[101,256],[97,258],[81,262],[81,266],[109,268],[61,270],[109,272],[81,274],[109,276],[61,278],[109,280],[89,282],[109,284],[61,286],[109,288],[89,290],[97,292],[101,294],[61,296],[89,298],[109,300],[61,302],[109,304],[89,306],[109,308],[61,310],[109,312],[81,314],[109,316],[61,318],[109,320],[81,322],[89,324],[93,326],[97,328],[69,330],[109,332],[69,334],[109,336],[69,338],[85,340],[97,342],[109,344],[89,346],[117,348],[69,350],[101,352],[53,354],[89,356],[57,358],[93,360],[97,362],[61,378],[101,380],[61,382],[101,384],[97,386]
    ];
  }

  catch (e) {}
}

function music_play()
{
  try
  {
    // Inspired by https://github.com/xem/miniMusic

    // Do the init if it hasn't been done already
    if (music.audioCtx==null)
      music_init();

    // Process all the notes in the song
    for (var i in music.f)
    {
      var e=music.audioCtx.currentTime+(music.f[parseInt(i,10)][1]*music.notelen);
      var osc=music.audioCtx.createOscillator();

      // Pan the note to where it would sound like if played on a piano
      osc.connect(music.panNode);
      music.panNode.pan.setValueAtTime(((music.f[parseInt(i,10)][0]/245)*2)-1, e);

      osc.type='triangle';

      // Convert the note from BBC Micro "pitch" to frequency in Hz
      osc.frequency.value=65.41*Math.pow(2, ((music.f[parseInt(i,10)][0]-5)/4)/12);

      // Set the start and stop times for the oscillator
      osc.start(e);
      osc.stop(e+music.notelen);
    }

    setTimeout(music_play, (music.notelen*1000)*(390));
  }

  catch (e) {}
}
